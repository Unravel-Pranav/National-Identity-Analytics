name: Monthly Data Sync

on:
  schedule:
    # Run at 00:00 on the 2nd of every month (to ensure Gov data availability)
    - cron: '0 0 2 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests python-dotenv

      - name: Run Data Sync
        env:
          DATA_GOV_API_KEY: ${{ secrets.DATA_GOV_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/sync_monthly_data.py sync

      - name: Upload to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create tag if it doesn't exist
          git tag -f dataset-latest
          git push -f origin dataset-latest

          # Create release if it doesn't exist
          gh release create dataset-latest \
            --title "Latest Monthly Dataset" \
            --notes "Auto-generated monthly dataset update." \
            --prerelease=false \
            --latest=true || true

          # Find newly updated/created CSVs (last 24h) and upload
          # We search in data/{dataset}/{year}/{month}.csv
          find data -name "*.csv" -type f -mtime -1 > updated_files.txt
          
          if [ -s updated_files.txt ]; then
            echo "Uploading updated files..."
            while IFS= read -r file; do
              # Construct a unique name for release asset: dataset_year_month.csv
              # e.g., data/biometric/2024/01.csv -> biometric_2024_01.csv
              filename=$(echo "$file" | awk -F'/' '{print $(NF-2) "_" $(NF-1) "_" $NF}')
              echo "Uploading $file as $filename"
              gh release upload dataset-latest "$file#$filename" --clobber
            done < updated_files.txt
          else
            echo "No new data files found to upload."
          fi
